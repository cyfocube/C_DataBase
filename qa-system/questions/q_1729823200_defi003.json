{
  "id": "q_1729823200_defi003",
  "title": "Curve StableSwap math implementation - getting price impact wrong",
  "content": "I'm implementing Curve's StableSwap invariant but my price impact calculations are way off compared to the actual Curve UI. Here's my invariant calculation:\n\n```python\ndef get_D(xp, amp):\n    \"\"\"\n    D invariant calculation in Curve StableSwap\n    \"\"\"\n    S = sum(xp)\n    if S == 0:\n        return 0\n    \n    Dprev = 0\n    D = S\n    Ann = amp * len(xp)\n    \n    for i in range(255):\n        D_P = D\n        for x in xp:\n            D_P = D_P * D // (len(xp) * x)\n        Dprev = D\n        D = (Ann * S + D_P * len(xp)) * D // ((Ann - 1) * D + (len(xp) + 1) * D_P)\n        \n        if abs(D - Dprev) <= 1:\n            break\n    \n    return D\n```\n\nWhen I test with USDC/USDT pool (A=2000), my calculations show:\n- Swapping 1000 USDC should give ~999.7 USDT (0.03% price impact)\n- Curve UI shows ~999.1 USDT (0.09% price impact)\n\nAm I missing fees? Using wrong precision? The whitepaper math seems to match my implementation but results are consistently off.",
  "tags": ["curve", "stableswap", "math", "defi", "amm", "price-impact"],
  "difficulty": "Expert",
  "bounty_amount": 300,
  "bounty_token": "USDC",
  "author_wallet": "0x9012345678901234567890123456789012345678",
  "author_name": "MathWhiz",
  "created_at": "2025-10-24T11:10:00Z",
  "updated_at": "2025-10-24T11:10:00Z",
  "views": 156,
  "votes": 18,
  "answer_count": 3,
  "is_answered": true,
  "accepted_answer_id": "a_1729823600_defi003",
  "last_activity": "2025-10-24T12:20:00Z"
}